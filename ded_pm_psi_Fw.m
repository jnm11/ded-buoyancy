function [F,ff,w]=ded_pm_psi_Fw(x,a)
%f = w(x).*exp(-a.^2.*x.^2)
%F = int_0.^x f(x) dx
% where the weight function w(x) is an even periodic window function
% x should be in [-pi,pi]

y=a.*x;
s=sin(x./2).^2;
w=(1-s).^3.*(1+6.*s.^2+3.*s);
ff=w.*exp(-y.^2);


if length(a)==1
  a=repmat(a,size(x));
end


% $$$ F1 = x/2+75/128.*sin(x)-25/768.*sin(3*x)+3/1280.*sin(5*x);
% $$$ F2 = -75/128.*(x.^2-2).*sin(x) -75./64.*x.*cos(x)...
% $$$      +25./6912.*(9.*x.^2-2).*sin(3.*x) +25./1152.*cos(3.*x).*x...
% $$$      -3./32000.*(25.*x.^2-2).*sin(5.*x)-3./3200.*cos(5.*x).*x-x.^3./6;
% $$$ F3 = 75./256.*(x.^4-12.*x.^2+24).*sin(x) +75./64.*x.*(x.^2-6).*cos(x) ...
% $$$      -25./41472.*(27.*x.^4-36.*x.^2+8).*sin(3.*x) -25./3456.*x.*(3.*x.^2-2).*cos(3.*x)...
% $$$      +3./1600000.*(625.*x.^4-300.*x.^2+24).*sin(5.*x)...
% $$$      +3./80000.*x.*(25.*x.^2-6).*cos(5.*x) +x.^5./20;
% $$$ F=F1+a.^2.*F2+a.^4.*F3;
F=(1/400).*a.^2.*x.*(-6+(x.^6-(42/25).*x.^4+(168/125).*x.^2-1008/3125).*a.^6+(-3.*x.^4+(12/5).*x.^2-72/125).*a.^4+(6.*x.^2-36/25).*a.^2).*cos(x).^5+(1/640).*(24+(x.^8-(56/25).*x.^6+(336/125).*x.^4-(4032/3125).*x.^2+8064/78125).*a.^8+(-4.*x.^6+(24/5).*x.^4-(288/125).*x.^2+576/3125).*a.^6+(12.*x.^4-(144/25).*x.^2+288/625).*a.^4+(-24.*x.^2+48/25).*a.^2).*sin(x).*cos(x).^4-19.*a.^2.*x.*(-6+(x.^6-(5894/1425).*x.^4+(562184/64125).*x.^2-1453648/253125).*a.^6+(-3.*x.^4+(1684/285).*x.^2-80312/21375).*a.^4+(6.*x.^2-1684/475).*a.^2).*cos(x).^3.*(1/1080)-(1/2880).*(19.*(24+(x.^8-(23576/4275).*x.^6+(1124368/64125).*x.^4-(5814592/253125).*x.^2+5488590464/1082109375).*a.^8+(-4.*x.^6+(3368/285).*x.^4-(321248/21375).*x.^2+830656/253125).*a.^6+(12.*x.^4-(6736/475).*x.^2+321248/106875).*a.^4+(-24.*x.^2+6736/1425).*a.^2)).*sin(x).*cos(x).^2+149.*a.^2.*x.*(-6+(x.^6-(445774/11175).*x.^4+(398947864/502875).*x.^2-179416061552/37715625).*a.^6+(-3.*x.^4+(127364/2235).*x.^2-56992552/167625).*a.^4+(6.*x.^2-127364/3725).*a.^2).*cos(x).*(1/720)+(1/2296350000000).*(1425650625000+(59402109375.*x.^8-3159423225000.*x.^6+94251432870000.*x.^4-1130321187777600.*x.^2+2260488695022208).*a.^8+(-237608437500.*x.^6+6770192625000.*x.^4-80786942460000.*x.^2+161474455396800).*a.^6+(712825312500.*x.^4-8124231150000.*x.^2+16157388492000).*a.^4+(-1425650625000.*x.^2+2708077050000).*a.^2).*sin(x)+(1/432).*(x.^8.*a.^8-(36/7).*x.^6.*a.^6+(108/5).*x.^4.*a.^4-72.*a.^2.*x.^2+216).*x;

E=exp(-1./(2*a).^2);
A=i./(2*a);
z2=sqrt(pi)./(512.*a).*real(150.*E.*    Faddeeva_erf_mex(y+A)...
                            -25.*E.^9 .*Faddeeva_erf_mex(y+3.*A)...
                             +3.*E.^25.*Faddeeva_erf_mex(y+5.*A)+128.*erf(y));
f=a>0.1;

F(f)=z2(f);

return;
aa=logspace(-4,0,20);
aa=[aa 1-aa];
x=linspace(-pi,pi,100);
e=1e-5;
for j=1:length(aa)
  figure(j);clf
  a=aa(j);
  [F,f,w]=ded_pm_psi_Fw(x,a);
  F1=ded_pm_psi_Fw(x+e,a);
  F2=ded_pm_psi_Fw(x-e,a);
  g=(F1-F2)/(2*e);
  subplot(2,1,1);
  plot(x,f,x,g);
  title(a);
  subplot(2,1,2);
  plot(x,f-g);
end
